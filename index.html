<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Rejects Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== GLOBAL VARIABLES ========== */
        :root {
            /* Color scheme */
            --primary-color: #2c3e50;
            --primary-light: #34495e;
            --secondary-color: #3498db;
            --secondary-light: #5dade2;
            --secondary-dark: #2980b9;
            --accent-color: #e67e22;
            --accent-light: #f39c12;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f1c40f;
            --info-color: #9b59b6;
            
            /* Neutral colors */
            --background-color: #f5f7fa;
            --card-bg-color: #ffffff;
            --border-color: #e0e0e0;
            --text-color: #333333;
            --text-muted: #7f8c8d;
            
            /* Typography */
            --base-font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --base-font-size: 14px;
            --small-font-size: 0.85rem;
            --heading-font-size: 1.1rem;
            --subheading-font-size: 0.95rem;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            
            /* Components */
            --border-radius-sm: 4px;
            --border-radius-md: 6px;
            --border-radius-lg: 8px;
            --card-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            --card-shadow-hover: 0 4px 8px rgba(0, 0, 0, 0.1);
            
            /* Layout */
            --header-height: 60px;
            --filter-height: 60px;
            --metrics-height: 80px;
            --footer-height: 40px;
        }

        /* ========== RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--base-font);
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: var(--base-font-size);
            line-height: 1.5;
        }
        
        button, input, select {
            font-family: inherit;
            font-size: inherit;
        }
        
        /* ========== LAYOUT ========== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 280px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 60px;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .dashboard-header {
            height: var(--header-height);
            background-color: var(--card-bg-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            padding: 0 var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }
        
        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        
        .header-title i {
            margin-right: var(--space-sm);
            color: var(--accent-color);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .date-control {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .date-control label {
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .date-control input[type="date"] {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 6px 8px;
            color: var(--text-color);
        }
        
        .apply-date-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .apply-date-btn:hover {
            background-color: var(--secondary-dark);
        }
        
        /* Filter Section */
        .filter-section {
            background-color: var(--card-bg-color);
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            white-space: nowrap;
        }
        
        .filter-group label {
            font-weight: 500;
            color: var(--primary-color);
            font-size: var(--small-font-size);
        }
        
        .select-container {
            position: relative;
            min-width: 140px;
        }
        
        .select-container select {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 6px 10px;
            appearance: none;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-sm) center;
            padding-right: 28px;
            cursor: pointer;
        }
        
        .filter-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-left: auto;
        }
        
        .reset-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: background-color 0.2s;
        }
        
        .reset-btn:hover {
            background-color: #c0392b;
        }
        
        /* Metrics Bar */
        .metrics-bar {
            height: var(--metrics-height);
            background-color: var(--card-bg-color);
            padding: 0 var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            overflow-x: auto;
        }
        
        .metrics-group {
            display: flex;
            align-items: center;
            gap: var(--space-xl);
        }
        
        .metric-item {
            display: flex;
            flex-direction: column;
        }
        
        .metric-value {
            font-size: 1.3rem;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .metric-label {
            font-size: var(--small-font-size);
            color: var(--text-muted);
        }
        
        .metric-item.cost .metric-value {
            color: var(--accent-color);
        }
        
        .metric-item.qty .metric-value {
            color: var(--secondary-dark);
        }
        
        .metric-breakdown {
            display: flex;
            gap: var(--space-lg);
        }
        
        .type-metric {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: var(--small-font-size);
        }
        
        .type-percent {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .special-stations-trigger {
            background-color: var(--info-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: background-color 0.2s;
        }
        
        .special-stations-trigger:hover {
            background-color: #8e44ad;
        }
        
        .special-stations-trigger i {
            transition: transform 0.3s;
        }
        
        .special-stations-trigger.active i {
            transform: rotate(180deg);
        }
        
        /* Special Stations Section */
        .special-stations-section {
            background-color: #f8f4fc;
            border-bottom: 1px solid #e1d5e7;
            padding: var(--space-md) var(--space-lg);
            display: none;
        }
        
        .special-stations-section.visible {
            display: block;
        }
        
        .special-stations-title {
            font-size: var(--subheading-font-size);
            font-weight: 600;
            color: var(--info-color);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .station-cards {
            display: flex;
            gap: var(--space-lg);
            overflow-x: auto;
            padding-bottom: var(--space-sm);
        }
        
        .station-card {
            background-color: white;
            border-radius: var(--border-radius-md);
            box-shadow: var(--card-shadow);
            padding: var(--space-md);
            min-width: 280px;
            border-top: 3px solid var(--info-color);
        }
        
        .station-card-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .station-card-metrics {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-sm);
        }
        
        .station-card-metric {
            display: flex;
            flex-direction: column;
        }
        
        .station-card-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .station-card-label {
            font-size: var(--small-font-size);
            color: var(--text-muted);
        }
        
        .station-card-reasons {
            margin-top: var(--space-sm);
        }
        
        .station-card-reasons-title {
            font-size: var(--small-font-size);
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: var(--space-xs);
        }
        
        .reason-item {
            display: flex;
            justify-content: space-between;
            font-size: var(--small-font-size);
            padding: 4px 0;
        }
        
        .reason-item:not(:last-child) {
            border-bottom: 1px dashed var(--border-color);
        }
        
        .reason-name {
            color: var(--text-color);
        }
        
        .reason-value {
            font-weight: 500;
            color: var(--primary-color);
        }
        
        /* Dashboard Content */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: var(--space-md);
            padding: var(--space-md);
            flex: 1;
            overflow: auto;
        }
        
        .dashboard-card {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .top-rejects-card {
            grid-column: 1;
            grid-row: 1 / span 2;
        }
        
        .card-header {
            padding: var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: var(--subheading-font-size);
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .card-controls {
            display: flex;
            gap: var(--space-sm);
        }
        
        .card-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            position: relative;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, 
        .data-table td {
            padding: var(--space-sm);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .data-table tbody tr:hover {
            background-color: #f5f9ff;
        }
        
        .data-table th.sortable {
            cursor: pointer;
        }
        
        .data-table th.sortable:hover {
            background-color: #edf2f7;
        }
        
        .data-table th.sortable::after {
            content: "⇅";
            margin-left: 5px;
            color: #adb5bd;
        }
        
        .data-table th.sorted-asc::after {
            content: "↑";
            color: var(--secondary-color);
        }
        
        .data-table th.sorted-desc::after {
            content: "↓";
            color: var(--secondary-color);
        }
        
        /* Chart containers */
        .chart-container {
            flex: 1;
            position: relative;
            padding: var(--space-md);
        }
        
        /* Toggle Buttons */
        .toggle-buttons {
            display: flex;
            gap: 1px;
            overflow: hidden;
            border-radius: var(--border-radius-sm);
            background-color: var(--border-color);
        }
        
        .toggle-btn {
            background-color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            font-size: var(--small-font-size);
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--secondary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .toggle-label {
            font-size: var(--small-font-size);
            margin-left: 8px;
        }
        
        /* Loading and empty states */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-sm);
        }
        
        .loading-text {
            font-size: var(--small-font-size);
            color: var(--text-muted);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: var(--space-lg);
            text-align: center;
        }
        
        .empty-icon {
            font-size: 2rem;
            color: var(--border-color);
            margin-bottom: var(--space-sm);
        }
        
        .empty-text {
            color: var(--text-muted);
            font-size: var(--small-font-size);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .top-rejects-card {
                grid-column: 1;
                grid-row: 1;
            }
        }
        
        @media (max-width: 768px) {
            .metrics-group {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-sm);
            }
            
            .station-cards {
                flex-direction: column;
            }
            
            .station-card {
                min-width: unset;
            }
            
            .dashboard-header {
                flex-direction: column;
                height: auto;
                padding: var(--space-sm);
            }
            
            .header-controls {
                width: 100%;
                margin-top: var(--space-sm);
            }
            
            .date-control {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .date-control input[type="date"] {
                width: 100%;
            }
            
            .apply-date-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="main-content">
            <div class="content-area">
                <!-- Dashboard Header -->
                <header class="dashboard-header">
                    <div class="header-title">
                        <i class="fas fa-chart-bar"></i>
                        Manufacturing Rejects Dashboard
                    </div>
                    <div class="header-controls">
                        <div class="date-control">
                            <label for="date-from">From:</label>
                            <input type="date" id="date-from">
                        </div>
                        <div class="date-control">
                            <label for="date-to">To:</label>
                            <input type="date" id="date-to">
                        </div>
                        <button id="apply-date" class="apply-date-btn">
                            <i class="fas fa-calendar-check"></i> Apply
                        </button>
                    </div>
                </header>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-group">
                        <label for="supervisor-filter">Supervisor:</label>
                        <div class="select-container">
                            <select id="supervisor-filter">
                                <option value="all">All Supervisors</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="product-filter">Product:</label>
                        <div class="select-container">
                            <select id="product-filter">
                                <option value="all">All Products</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="variant-filter">Variant:</label>
                        <div class="select-container">
                            <select id="variant-filter">
                                <option value="all">All Variants</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="station-filter">Station:</label>
                        <div class="select-container">
                            <select id="station-filter">
                                <option value="all">All Stations</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="reason-filter">Reason:</label>
                        <div class="select-container">
                            <select id="reason-filter">
                                <option value="all">All Reasons</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-buttons">
                        <button id="reset-filters" class="reset-btn">
                            <i class="fas fa-undo"></i> Reset Filters
                        </button>
                    </div>
                </div>

                <!-- Metrics Bar -->
                <div class="metrics-bar">
                    <div class="metrics-group">
                        <div class="metric-item cost">
                            <div class="metric-value" id="total-cost">R0</div>
                            <div class="metric-label">Total Cost</div>
                        </div>
                        
                        <div class="metric-item qty">
                            <div class="metric-value" id="total-qty">0</div>
                            <div class="metric-label">Total Quantity</div>
                        </div>
                        
                        <div class="metric-breakdown">
                            <div class="type-metric" id="scrap-metric">
                                <span>Scrap:</span>
                                <span id="scrap-percent" class="type-percent">0%</span>
                            </div>
                            <div class="type-metric" id="rts-metric">
                                <span>RTS:</span>
                                <span id="rts-percent" class="type-percent">0%</span>
                            </div>
                            <div class="type-metric" id="local-metric">
                                <span>Local:</span>
                                <span id="local-percent" class="type-percent">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="special-stations-toggle" class="special-stations-trigger">
                        <i class="fas fa-chevron-down"></i> Special Stations Analysis
                    </button>
                </div>

                <!-- Special Stations Section (Initially Hidden) -->
                <div id="special-stations-section" class="special-stations-section">
                    <div class="special-stations-title">
                        <i class="fas fa-microscope"></i> Key Station Analysis
                    </div>
                    <div class="station-cards" id="special-station-cards">
                        <!-- Cards will be added dynamically -->
                    </div>
                </div>

                <!-- Dashboard Content Grid -->
                <div class="dashboard-grid">
                    <!-- Top Rejects Table Card -->
                    <div class="dashboard-card top-rejects-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-exclamation-triangle"></i> Top Rejects
                            </div>
                            <div class="card-controls">
                                <div class="toggle-buttons">
                                    <button id="sort-by-qty" class="toggle-btn active">Qty</button>
                                    <button id="sort-by-cost" class="toggle-btn">Cost</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-content">
                            <table class="data-table" id="top-rejects-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="station">Station</th>
                                        <th data-sort="parts">Parts</th>
                                        <th class="sortable" data-sort="reason">Reject Reason</th>
                                        <th data-sort="qty">QTY</th>
                                        <th data-sort="cost">Cost (R)</th>
                                    </tr>
                                </thead>
                                <tbody id="top-rejects-body">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                            
                            <!-- Empty state (hidden by default) -->
                            <div class="empty-state" id="top-rejects-empty" style="display: none;">
                                <div class="empty-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="empty-text">No reject data found for the selected filters.</div>
                            </div>
                            
                            <!-- Loading overlay (hidden by default) -->
                            <div class="loading-overlay" id="top-rejects-loading" style="display: none;">
                                <div class="spinner"></div>
                                <div class="loading-text">Loading data...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Daily Trend Chart Card -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-line"></i> Daily Rejects Trend
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="chart-container" id="trend-chart-container">
                                <!-- Chart will be rendered here -->
                            </div>
                            
                            <!-- Empty state (hidden by default) -->
                            <div class="empty-state" id="trend-chart-empty" style="display: none;">
                                <div class="empty-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="empty-text">No trend data available for the selected period.</div>
                            </div>
                            
                            <!-- Loading overlay (hidden by default) -->
                            <div class="loading-overlay" id="trend-chart-loading" style="display: none;">
                                <div class="spinner"></div>
                                <div class="loading-text">Generating chart...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Reasons Chart Card -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-exclamation-circle"></i> Top Reject Reasons
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="chart-container" id="reasons-chart-container">
                                <!-- Chart will be rendered here -->
                            </div>
                            
                            <!-- Empty state (hidden by default) -->
                            <div class="empty-state" id="reasons-chart-empty" style="display: none;">
                                <div class="empty-icon">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <div class="empty-text">No reason data available for the selected filters.</div>
                            </div>
                            
                            <!-- Loading overlay (hidden by default) -->
                            <div class="loading-overlay" id="reasons-chart-loading" style="display: none;">
                                <div class="spinner"></div>
                                <div class="loading-text">Generating chart...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SVG Definitions for Icons and Patterns -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <!-- Patterns for charts -->
            <pattern id="pattern-stripe" width="4" height="4" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                <rect width="2" height="4" transform="translate(0,0)" fill="white"></rect>
            </pattern>
            <mask id="mask-stripe">
                <rect x="0" y="0" width="100%" height="100%" fill="url(#pattern-stripe)"></rect>
            </mask>
        </defs>
    </svg>

    <!-- Load libraries from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

    <script>
    /**
     * Manufacturing Rejects Dashboard
     * 
     * A modular, maintainable dashboard for visualizing manufacturing reject data.
     * This application follows a modular pattern with clear separation of concerns:
     * 
     * 1. DataModule: Handles data loading, filtering, and manipulation
     * 2. UIModule: Manages UI interactions and rendering
     * 3. ChartModule: Creates and updates data visualizations
     * 4. DashboardModule: Orchestrates the overall application
     */

    /**
     * Utility Module
     * Provides helper functions used throughout the application
     */
    const Utils = (function() {
        // Format currency values
        const formatCurrency = (value) => {
            return 'R' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        };
        
        // Format date objects to YYYY-MM-DD
        const formatDateForAPI = (date) => {
            return date.toISOString().split('T')[0];
        };
        
        // Format date for display
        const formatDateForDisplay = (dateString) => {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        };
        
        // Group array of objects by a property
        const groupBy = (array, key) => {
            return array.reduce((result, item) => {
                (result[item[key]] = result[item[key]] || []).push(item);
                return result;
            }, {});
        };
        
        // Safely access nested object properties
        const getNestedProperty = (obj, path, defaultValue = undefined) => {
            const pathArray = Array.isArray(path) ? path : path.split('.');
            let current = obj;
            
            for (let i = 0; i < pathArray.length; i++) {
                if (current === null || current === undefined) {
                    return defaultValue;
                }
                current = current[pathArray[i]];
            }
            
            return current === undefined ? defaultValue : current;
        };
        
        // Debounce function for performance
        const debounce = (func, wait) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        };
        
        // Show loading state
        const showLoading = (elementId) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'flex';
            }
        };
        
        // Hide loading state
        const hideLoading = (elementId) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        };
        
        // Show empty state
        const showEmpty = (elementId) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'flex';
            }
        };
        
        // Hide empty state
        const hideEmpty = (elementId) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        };
        
        // Generate a random ID
        const generateId = () => {
            return Math.random().toString(36).substring(2, 15);
        };
        
        // Calculate the date range for the last N days
        const getLastNDaysRange = (days) => {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - days);
            return { start, end };
        };
        
        return {
            formatCurrency,
            formatDateForAPI,
            formatDateForDisplay,
            groupBy,
            getNestedProperty,
            debounce,
            showLoading,
            hideLoading,
            showEmpty,
            hideEmpty,
            generateId,
            getLastNDaysRange
        };
    })();

    /**
     * Data Module
     * Handles data loading, filtering, and manipulation
     */
    const DataModule = (function() {
        // Private state
        let indexData = null;
        let rejectData = [];
        let filteredData = [];
        let loadedMonths = {};
        let currentFilters = {
            dateFrom: null,
            dateTo: null,
            supervisor: 'all',
            product: 'all',
            variant: 'all',
            station: 'all',
            reason: 'all',
            action: 'all'
        };
        
        // Special stations to track
        const specialStations = ['Wrapping & Checkers', 'FI', 'Checkers', 'Wrapping'];
        
        // Initialize data module
        const init = async function() {
            try {
                // Fetch the index data that contains available periods
                const indexResponse = await fetch('RejectsIndex.json');
                if (!indexResponse.ok) {
                    throw new Error('Failed to load index data');
                }
                
                indexData = await indexResponse.json();
                
                // Set default date range (last 30 days or based on available data)
                const { start, end } = Utils.getLastNDaysRange(30);
                currentFilters.dateFrom = start;
                currentFilters.dateTo = end;
                
                return true;
            } catch (error) {
                console.error('Error initializing data module:', error);
                return false;
            }
        };
        
        // Load data for current date range
        const loadDataForDateRange = async function() {
            if (!indexData || !currentFilters.dateFrom || !currentFilters.dateTo) {
                return false;
            }
            
            try {
                // Get list of months needed for the date range
                const monthsToLoad = getMonthsInRange(
                    currentFilters.dateFrom, 
                    currentFilters.dateTo
                );
                
                if (monthsToLoad.length === 0) {
                    throw new Error('No data available for selected date range');
                }
                
                // Reset data arrays
                rejectData = [];
                
                // Load each required month
                for (const month of monthsToLoad) {
                    if (!loadedMonths[month]) {
                        try {
                            const monthResponse = await fetch(`data/${month}.json`);
                            if (!monthResponse.ok) {
                                console.warn(`Month data for ${month} not available or error`);
                                continue;
                            }
                            
                            const monthData = await monthResponse.json();
                            loadedMonths[month] = monthData.rejectData || [];
                        } catch (error) {
                            console.warn(`Error loading data for ${month}:`, error);
                            continue;
                        }
                    }
                    
                    // Add this month's data
                    rejectData = rejectData.concat(loadedMonths[month]);
                }
                
                // Apply date filtering
                applyAllFilters();
                
                return true;
            } catch (error) {
                console.error('Error loading data for date range:', error);
                return false;
            }
        };
        
        // Get months between two dates (YYYY-MM format)
        const getMonthsInRange = function(startDate, endDate) {
            const months = [];
            const currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            const endMonthDate = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0);
            
            while (currentDate <= endMonthDate) {
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const monthStr = `${year}-${month}`;
                
                if (indexData && indexData.availablePeriods && 
                    indexData.availablePeriods.includes(monthStr)) {
                    months.push(monthStr);
                }
                
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            return months;
        };
        
        // Apply all filters to the data
        const applyAllFilters = function() {
            // First, filter by date range
            let result = rejectData.filter(item => {
                if (!item.ProductionDate) return false;
                const itemDate = new Date(item.ProductionDate);
                return itemDate >= currentFilters.dateFrom && 
                       itemDate <= currentFilters.dateTo;
            });
            
            // Apply other filters
            if (currentFilters.supervisor !== 'all') {
                result = result.filter(item => 
                    item.LineSupervisor === currentFilters.supervisor);
            }
            
            if (currentFilters.product !== 'all') {
                result = result.filter(item => 
                    item.Product === currentFilters.product);
            }
            
            if (currentFilters.variant !== 'all') {
                result = result.filter(item => 
                    item.Variant === currentFilters.variant);
            }
            
            if (currentFilters.station !== 'all') {
                result = result.filter(item => 
                    item.Station === currentFilters.station);
            }
            
            if (currentFilters.reason !== 'all') {
                result = result.filter(item => 
                    item.RejectReason === currentFilters.reason);
            }
            
            if (currentFilters.action !== 'all') {
                result = result.filter(item => 
                    item.ActionSelection === currentFilters.action);
            }
            
            filteredData = result;
            return filteredData;
        };
        
        // Get available filter options
        const getFilterOptions = function() {
            const options = {
                supervisor: new Set(),
                product: new Set(),
                variant: new Set(),
                station: new Set(),
                reason: new Set(),
                action: new Set()
            };
            
            // Use raw data to get all possible values
            rejectData.forEach(item => {
                if (item.LineSupervisor) options.supervisor.add(item.LineSupervisor);
                if (item.Product) options.product.add(item.Product);
                if (item.Variant) options.variant.add(item.Variant);
                if (item.Station) options.station.add(item.Station);
                if (item.RejectReason) options.reason.add(item.RejectReason);
                if (item.ActionSelection) options.action.add(item.ActionSelection);
            });
            
            // Convert Sets to sorted arrays
            return {
                supervisor: [...options.supervisor].sort(),
                product: [...options.product].sort(),
                variant: [...options.variant].sort(),
                station: [...options.station].sort(),
                reason: [...options.reason].sort(),
                action: [...options.action].sort()
            };
        };
        
        // Update a filter value
        const setFilter = function(filterName, value) {
            if (filterName in currentFilters) {
                currentFilters[filterName] = value;
                applyAllFilters();
                return true;
            }
            return false;
        };
        
        // Reset all filters except date range
        const resetFilters = function() {
            currentFilters.supervisor = 'all';
            currentFilters.product = 'all';
            currentFilters.variant = 'all';
            currentFilters.station = 'all';
            currentFilters.reason = 'all';
            currentFilters.action = 'all';
            
            applyAllFilters();
            return true;
        };
        
        // Set date range filter
        const setDateRange = function(fromDate, toDate) {
            currentFilters.dateFrom = fromDate;
            currentFilters.dateTo = toDate;
            return true;
        };
        
        // Get top rejects sorted by metric
        const getTopRejects = function(limit = 10, sortBy = 'qty') {
            // Group data by station and reason
            const groupedData = {};
            
            filteredData.forEach(item => {
                const key = `${item.Station || 'Unknown'}-${item.RejectReason || 'Unknown'}`;
                if (!groupedData[key]) {
                    // Get parts array
                    let parts = [];
                    if (Array.isArray(item.Parts)) {
                        parts = item.Parts.filter(p => p && p.trim());
                    } else if (typeof item.Parts === 'string') {
                        parts = item.Parts.split(',').map(p => p.trim()).filter(p => p);
                    }
                    
                    groupedData[key] = {
                        station: item.Station || 'Unknown',
                        rejectReason: item.RejectReason || 'Unknown',
                        parts: new Set(parts),
                        items: [item],
                        qty: 0,
                        cost: 0
                    };
                } else {
                    groupedData[key].items.push(item);
                    
                    // Add parts to the set
                    let parts = [];
                    if (Array.isArray(item.Parts)) {
                        parts = item.Parts.filter(p => p && p.trim());
                    } else if (typeof item.Parts === 'string') {
                        parts = item.Parts.split(',').map(p => p.trim()).filter(p => p);
                    }
                    
                    parts.forEach(part => {
                        if (part) groupedData[key].parts.add(part);
                    });
                }
                
                // Accumulate qty and cost
                groupedData[key].qty += (item.QTY || 0);
                groupedData[key].cost += (item.Cost || 0);
            });
            
            // Convert to array and sort
            let sortedData = Object.values(groupedData);
            
            if (sortBy === 'qty') {
                sortedData.sort((a, b) => b.qty - a.qty);
            } else {
                sortedData.sort((a, b) => b.cost - a.cost);
            }
            
            // Format parts as comma-separated string
            sortedData = sortedData.map(item => ({
                ...item,
                parts: Array.from(item.parts).join(', ')
            }));
            
            return sortedData.slice(0, limit);
        };
        
        // Get data for trend chart
        const getTrendChartData = function(sortBy = 'qty') {
            // Group by date and count/sum
            const dailyData = {};
            
            filteredData.forEach(item => {
                if (!item.ProductionDate) return;
                
                const date = item.ProductionDate;
                if (!dailyData[date]) {
                    dailyData[date] = { date, qty: 0, cost: 0 };
                }
                
                dailyData[date].qty += (item.QTY || 0);
                dailyData[date].cost += (item.Cost || 0);
            });
            
            // Convert to array and sort by date
            const trendData = Object.values(dailyData).sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            return trendData;
        };
        
        // Get top reject reasons data
        const getTopReasons = function(limit = 5, sortBy = 'qty') {
            // Group by reason
            const reasonsData = {};
            
            filteredData.forEach(item => {
                const reason = item.RejectReason || 'Unknown';
                
                if (!reasonsData[reason]) {
                    reasonsData[reason] = { 
                        reason, 
                        qty: 0, 
                        cost: 0,
                        products: new Set(),
                        stations: new Set()
                    };
                }
                
                reasonsData[reason].qty += (item.QTY || 0);
                reasonsData[reason].cost += (item.Cost || 0);
                
                if (item.Product) reasonsData[reason].products.add(item.Product);
                if (item.Station) reasonsData[reason].stations.add(item.Station);
            });
            
            // Convert to array and sort
            let sortedData = Object.values(reasonsData);
            
            if (sortBy === 'qty') {
                sortedData.sort((a, b) => b.qty - a.qty);
            } else {
                sortedData.sort((a, b) => b.cost - a.cost);
            }
            
            return sortedData.slice(0, limit);
        };
        
        // Get metrics summary
        const getMetricsSummary = function() {
            const totalQty = filteredData.reduce((sum, item) => sum + (item.QTY || 0), 0);
            const totalCost = filteredData.reduce((sum, item) => sum + (item.Cost || 0), 0);
            
            const scrapCount = filteredData
                .filter(item => item.ActionSelection === 'Scrap')
                .reduce((sum, item) => sum + (item.QTY || 0), 0);
                
            const rtsCount = filteredData
                .filter(item => item.ActionSelection === 'RTS')
                .reduce((sum, item) => sum + (item.QTY || 0), 0);
                
            const localCount = filteredData
                .filter(item => item.ActionSelection === 'Local')
                .reduce((sum, item) => sum + (item.QTY || 0), 0);
                
            const scrapPercent = totalQty > 0 ? Math.round((scrapCount / totalQty) * 100) : 0;
            const rtsPercent = totalQty > 0 ? Math.round((rtsCount / totalQty) * 100) : 0;
            const localPercent = totalQty > 0 ? Math.round((localCount / totalQty) * 100) : 0;
            
            let singlePartsCount = 0;
            let assembliesCount = 0;
            
            filteredData.forEach(item => {
                let parts = [];
                if (Array.isArray(item.Parts)) {
                    parts = item.Parts.filter(p => p && p.trim());
                } else if (typeof item.Parts === 'string') {
                    parts = item.Parts.split(',').map(p => p.trim()).filter(p => p);
                }
                
                if (parts.length <= 1) {
                    singlePartsCount += (item.QTY || 0);
                } else {
                    assembliesCount += (item.QTY || 0);
                }
            });
            
            return {
                totalQty,
                totalCost,
                scrapCount,
                rtsCount,
                localCount,
                scrapPercent,
                rtsPercent,
                localPercent,
                singlePartsCount,
                assembliesCount
            };
        };
        
        // Get special stations data
        const getSpecialStationsData = function() {
            const stationsData = {};
            
            // Initialize data structure for each special station
            specialStations.forEach(station => {
                stationsData[station] = {
                    name: station,
                    qty: 0,
                    cost: 0,
                    reasons: {},
                    items: []
                };
            });
            
            // Process filtered data
            filteredData.forEach(item => {
                if (!item.Station) return;
                
                // Check if this item belongs to a special station
                specialStations.forEach(stationName => {
                    if (item.Station.includes(stationName)) {
                        stationsData[stationName].qty += (item.QTY || 0);
                        stationsData[stationName].cost += (item.Cost || 0);
                        stationsData[stationName].items.push(item);
                        
                        // Track reasons
                        const reason = item.RejectReason || 'Unknown';
                        if (!stationsData[stationName].reasons[reason]) {
                            stationsData[stationName].reasons[reason] = {
                                name: reason,
                                qty: 0,
                                cost: 0
                            };
                        }
                        
                        stationsData[stationName].reasons[reason].qty += (item.QTY || 0);
                        stationsData[stationName].reasons[reason].cost += (item.Cost || 0);
                    }
                });
            });
            
            // Convert reasons to arrays and sort
            Object.keys(stationsData).forEach(station => {
                if (stationsData[station].items.length === 0) {
                    return;
                }
                
                const reasonsArray = Object.values(stationsData[station].reasons)
                    .sort((a, b) => b.qty - a.qty);
                    
                stationsData[station].topReasons = reasonsArray.slice(0, 3);
            });
            
            // Filter out stations with no data
            const result = Object.values(stationsData)
                .filter(station => station.items.length > 0);
                
            return result;
        };
        
        // Return public methods
        return {
            init,
            loadDataForDateRange,
            setFilter,
            resetFilters,
            setDateRange,
            getFilterOptions,
            getTopRejects,
            getTrendChartData,
            getTopReasons,
            getMetricsSummary,
            getSpecialStationsData,
            specialStations
        };
    })();

    /**
     * Chart Module
     * Creates and updates data visualizations
     */
    const ChartModule = (function() {
        // Trend chart
        const createTrendChart = function(containerId, data, sortBy = 'qty') {
            const container = document.getElementById(containerId);
            if (!container || !data || data.length === 0) return;
            
            // Clear previous chart
            container.innerHTML = '';
            
            // Set up dimensions
            const margin = { top: 20, right: 20, bottom: 40, left: 50 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;
            
            // Create SVG
            const svg = d3.select(container)
                .append('svg')
                .attr('width', container.clientWidth)
                .attr('height', container.clientHeight)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create scales
            const xScale = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, width])
                .padding(0.2);
            
            const metric = sortBy === 'qty' ? 'qty' : 'cost';
            const yMax = d3.max(data, d => d[metric]) * 1.1; // Add 10% padding
            
            const yScale = d3.scaleLinear()
                .domain([0, yMax])
                .range([height, 0]);
            
            // Create axes
            const xAxis = svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale)
                    .tickFormat(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    })
                    .tickValues(xScale.domain().filter((d, i) => {
                        // Show fewer ticks on the x-axis for readability
                        const numTicks = width > 600 ? 10 : 5;
                        return i % Math.ceil(data.length / numTicks) === 0;
                    }))
                );
            
            // Rotate x-axis labels if needed
            if (data.length > 10) {
                xAxis.selectAll('text')
                    .attr('transform', 'rotate(-45)')
                    .attr('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em');
            }
            
            const yAxis = svg.append('g')
                .call(d3.axisLeft(yScale)
                    .ticks(5)
                    .tickFormat(d => sortBy === 'cost' ? `R${d}` : d)
                );
            
            // Add grid lines
            svg.append('g')
                .attr('class', 'grid')
                .selectAll('line')
                .data(yScale.ticks(5))
                .enter()
                .append('line')
                .attr('x1', 0)
                .attr('x2', width)
                .attr('y1', d => yScale(d))
                .attr('y2', d => yScale(d))
                .attr('stroke', '#e0e0e0')
                .attr('stroke-width', 1);
                
            // Create bars
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.date))
                .attr('y', d => yScale(d[metric]))
                .attr('width', xScale.bandwidth())
                .attr('height', d => height - yScale(d[metric]))
                .attr('fill', '#3498db')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .attr('fill', '#e67e22');
                    
                    // Add tooltip
                    const tooltip = d3.select('body')
                        .append('div')
                        .attr('class', 'chart-tooltip')
                        .style('position', 'absolute')
                        .style('background', 'rgba(0, 0, 0, 0.8)')
                        .style('color', 'white')
                        .style('padding', '5px 10px')
                        .style('border-radius', '4px')
                        .style('font-size', '12px')
                        .style('pointer-events', 'none')
                        .style('z-index', 1000);
                    
                    tooltip.html(`
                        <div>Date: ${Utils.formatDateForDisplay(d.date)}</div>
                        <div>Quantity: ${d.qty}</div>
                        <div>Cost: ${Utils.formatCurrency(d.cost)}</div>
                    `);
                    
                    tooltip
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 30) + 'px');
                })
                .on('mousemove', function(event) {
                    d3.select('.chart-tooltip')
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 30) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .attr('fill', '#3498db');
                    
                    d3.select('.chart-tooltip').remove();
                });
            
            // Add labels
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', `translate(${width/2},${height + margin.bottom - 5})`)
                .style('font-size', '12px')
                .text('Date');
            
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', `rotate(-90) translate(${-height/2},${-margin.left + 15})`)
                .style('font-size', '12px')
                .text(sortBy === 'cost' ? 'Cost (R)' : 'Quantity');
                
            // Add a trendline
            if (data.length > 2) {
                const linePlotter = d3.line()
                    .x(d => xScale(d.date) + xScale.bandwidth() / 2)
                    .y(d => yScale(d[metric]))
                    .curve(d3.curveMonotoneX);
                
                svg.append('path')
                    .datum(data)
                    .attr('fill', 'none')
                    .attr('stroke', '#e74c3c')
                    .attr('stroke-width', 2)
                    .attr('d', linePlotter);
            }
            
            return svg.node();
        };
        
        // Reasons chart
        const createReasonsChart = function(containerId, data, sortBy = 'qty') {
            const container = document.getElementById(containerId);
            if (!container || !data || data.length === 0) return;
            
            // Clear previous chart
            container.innerHTML = '';
            
            // Set up dimensions
            const margin = { top: 20, right: 20, bottom: 40, left: 180 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;
            
            // If multiple reasons share the same count/cost, sort alphabetically as a tie-breaker
            data.sort((a, b) => {
                const metricA = sortBy === 'qty' ? a.qty : a.cost;
                const metricB = sortBy === 'qty' ? b.qty : b.cost;
                
                if (metricB !== metricA) {
                    return metricB - metricA;
                }
                
                return a.reason.localeCompare(b.reason);
            });
            
            // Create SVG
            const svg = d3.select(container)
                .append('svg')
                .attr('width', container.clientWidth)
                .attr('height', container.clientHeight)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Create scales
            const yScale = d3.scaleBand()
                .domain(data.map(d => d.reason))
                .range([0, height])
                .padding(0.2);
            
            const metric = sortBy === 'qty' ? 'qty' : 'cost';
            const xMax = d3.max(data, d => d[metric]) * 1.1; // Add 10% padding
            
            const xScale = d3.scaleLinear()
                .domain([0, xMax])
                .range([0, width]);
            
            // Create axes
            const yAxis = svg.append('g')
                .call(d3.axisLeft(yScale)
                    .tickFormat(d => {
                        // Truncate long reason names
                        return d.length > 25 ? d.substring(0, 22) + '...' : d;
                    })
                );
            
            const xAxis = svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale)
                    .ticks(5)
                    .tickFormat(d => sortBy === 'cost' ? `R${d}` : d)
                );
            
            // Add grid lines
            svg.append('g')
                .attr('class', 'grid')
                .selectAll('line')
                .data(xScale.ticks(5))
                .enter()
                .append('line')
                .attr('x1', d => xScale(d))
                .attr('x2', d => xScale(d))
                .attr('y1', 0)
                .attr('y2', height)
                .attr('stroke', '#e0e0e0')
                .attr('stroke-width', 1);
                
            // Create horizontal bars
            const bars = svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('y', d => yScale(d.reason))
                .attr('x', 0)
                .attr('height', yScale.bandwidth())
                .attr('width', d => xScale(d[metric]))
                .attr('fill', (d, i) => {
                    // Use colors array for visualization
                    const colors = [
                        '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', 
                        '#1abc9c', '#e67e22', '#34495e'
                    ];
                    return colors[i % colors.length];
                })
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .attr('opacity', 0.8);
                    
                    // Add tooltip
                    const tooltip = d3.select('body')
                        .append('div')
                        .attr('class', 'chart-tooltip')
                        .style('position', 'absolute')
                        .style('background', 'rgba(0, 0, 0, 0.8)')
                        .style('color', 'white')
                        .style('padding', '8px 12px')
                        .style('border-radius', '4px')
                        .style('font-size', '12px')
                        .style('pointer-events', 'none')
                        .style('z-index', 1000);
                    
                    const stationsStr = Array.from(d.stations || []).slice(0, 3).join(', ');
                    const stationsMore = (d.stations || []).size > 3 ? `... and ${(d.stations || []).size - 3} more` : '';
                    
                    const productsStr = Array.from(d.products || []).slice(0, 3).join(', ');
                    const productsMore = (d.products || []).size > 3 ? `... and ${(d.products || []).size - 3} more` : '';
                    
                    tooltip.html(`
                        <div style="font-weight: bold; margin-bottom: 5px;">${d.reason}</div>
                        <div>Quantity: ${d.qty}</div>
                        <div>Cost: ${Utils.formatCurrency(d.cost)}</div>
                        ${stationsStr ? `<div style="margin-top: 5px;">Stations: ${stationsStr} ${stationsMore}</div>` : ''}
                        ${productsStr ? `<div>Products: ${productsStr} ${productsMore}</div>` : ''}
                    `);
                    
                    tooltip
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mousemove', function(event) {
                    d3.select('.chart-tooltip')
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .attr('opacity', 1);
                    
                    d3.select('.chart-tooltip').remove();
                });
            
            // Add value labels to the bars
            svg.selectAll('.label')
                .data(data)
                .enter()
                .append('text')
                .attr('class', 'label')
                .attr('y', d => yScale(d.reason) + yScale.bandwidth() / 2 + 4)
                .attr('x', d => xScale(d[metric]) + 5)
                .attr('text-anchor', 'start')
                .attr('font-size', '11px')
                .attr('fill', '#333')
                .text(d => sortBy === 'cost' ? 
                    `R${d.cost.toFixed(0)} (${d.qty})` : 
                    `${d.qty} (R${d.cost.toFixed(0)})`
                );
            
            // Add labels
            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('transform', `translate(${width/2},${height + margin.bottom - 5})`)
                .style('font-size', '12px')
                .text(sortBy === 'cost' ? 'Cost (R)' : 'Quantity');
            
            return svg.node();
        };
        
        // Return public methods
        return {
            createTrendChart,
            createReasonsChart
        };
    })();

    /**
     * UI Module
     * Manages UI interactions and rendering
     */
    const UIModule = (function() {
        // DOM elements
        const elements = {
            // Date controls
            dateFrom: document.getElementById('date-from'),
            dateTo: document.getElementById('date-to'),
            applyDateBtn: document.getElementById('apply-date'),
            
            // Filters
            supervisorFilter: document.getElementById('supervisor-filter'),
            productFilter: document.getElementById('product-filter'),
            variantFilter: document.getElementById('variant-filter'),
            stationFilter: document.getElementById('station-filter'),
            reasonFilter: document.getElementById('reason-filter'),
            resetFiltersBtn: document.getElementById('reset-filters'),
            
            // Metrics
            totalCost: document.getElementById('total-cost'),
            totalQty: document.getElementById('total-qty'),
            scrapMetric: document.getElementById('scrap-metric'),
            rtsMetric: document.getElementById('rts-metric'),
            localMetric: document.getElementById('local-metric'),
            scrapPercent: document.getElementById('scrap-percent'),
            rtsPercent: document.getElementById('rts-percent'),
            localPercent: document.getElementById('local-percent'),
            
            // Special stations section
            specialStationsToggle: document.getElementById('special-stations-toggle'),
            specialStationsSection: document.getElementById('special-stations-section'),
            specialStationCards: document.getElementById('special-station-cards'),
            
            // Tables and charts
            topRejectsTable: document.getElementById('top-rejects-table'),
            topRejectsBody: document.getElementById('top-rejects-body'),
            sortByQty: document.getElementById('sort-by-qty'),
            sortByCost: document.getElementById('sort-by-cost'),
            topRejectsEmpty: document.getElementById('top-rejects-empty'),
            topRejectsLoading: document.getElementById('top-rejects-loading'),
            
            trendChartContainer: document.getElementById('trend-chart-container'),
            trendChartEmpty: document.getElementById('trend-chart-empty'),
            trendChartLoading: document.getElementById('trend-chart-loading'),
            
            reasonsChartContainer: document.getElementById('reasons-chart-container'),
            reasonsChartEmpty: document.getElementById('reasons-chart-empty'),
            reasonsChartLoading: document.getElementById('reasons-chart-loading')
        };
        
        // Current state
        let currentSortBy = 'qty'; // 'qty' or 'cost'
        
        // Initialize the UI module
        const init = function() {
            // Set up event listeners
            setupEventListeners();
            return true;
        };
        
        // Set up event listeners
        const setupEventListeners = function() {
            // Date controls
            elements.applyDateBtn.addEventListener('click', () => {
                const fromDate = elements.dateFrom.value ? new Date(elements.dateFrom.value) : null;
                const toDate = elements.dateTo.value ? new Date(elements.dateTo.value) : null;
                
                if (fromDate && toDate) {
                    // Set end of day for toDate to include the full day
                    toDate.setHours(23, 59, 59, 999);
                    
                    // Trigger date change event
                    triggerEvent('dateRangeChanged', { fromDate, toDate });
                }
            });
            
            // Filter dropdowns
            elements.supervisorFilter.addEventListener('change', () => {
                triggerEvent('filterChanged', { 
                    name: 'supervisor', 
                    value: elements.supervisorFilter.value 
                });
            });
            
            elements.productFilter.addEventListener('change', () => {
                triggerEvent('filterChanged', { 
                    name: 'product', 
                    value: elements.productFilter.value 
                });
            });
            
            elements.variantFilter.addEventListener('change', () => {
                triggerEvent('filterChanged', { 
                    name: 'variant', 
                    value: elements.variantFilter.value 
                });
            });
            
            elements.stationFilter.addEventListener('change', () => {
                triggerEvent('filterChanged', { 
                    name: 'station', 
                    value: elements.stationFilter.value 
                });
            });
            
            elements.reasonFilter.addEventListener('change', () => {
                triggerEvent('filterChanged', { 
                    name: 'reason', 
                    value: elements.reasonFilter.value 
                });
            });
            
            // Reset filters button
            elements.resetFiltersBtn.addEventListener('click', () => {
                triggerEvent('resetFilters');
            });
            
            // Sort toggle buttons
            elements.sortByQty.addEventListener('click', () => {
                if (currentSortBy !== 'qty') {
                    currentSortBy = 'qty';
                    elements.sortByQty.classList.add('active');
                    elements.sortByCost.classList.remove('active');
                    triggerEvent('sortChanged', { sortBy: 'qty' });
                }
            });
            
            elements.sortByCost.addEventListener('click', () => {
                if (currentSortBy !== 'cost') {
                    currentSortBy = 'cost';
                    elements.sortByCost.classList.add('active');
                    elements.sortByQty.classList.remove('active');
                    triggerEvent('sortChanged', { sortBy: 'cost' });
                }
            });
            
            // Special stations toggle
            elements.specialStationsToggle.addEventListener('click', () => {
                elements.specialStationsSection.classList.toggle('visible');
                elements.specialStationsToggle.classList.toggle('active');
                
                // Update special stations data if section becomes visible
                if (elements.specialStationsSection.classList.contains('visible')) {
                    triggerEvent('specialStationsToggled', { visible: true });
                }
            });
            
            // Table header sorting
            elements.topRejectsTable.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const sortField = th.getAttribute('data-sort');
                    if (sortField) {
                        triggerEvent('tableHeaderSorted', { field: sortField });
                    }
                });
            });
        };
        
        // Populate filter dropdowns
        const populateFilterDropdowns = function(filterOptions) {
            if (!filterOptions) return;
            
            // Clear and populate supervisor filter
            populateDropdown(elements.supervisorFilter, filterOptions.supervisor, 'All Supervisors');
            
            // Clear and populate product filter
            populateDropdown(elements.productFilter, filterOptions.product, 'All Products');
            
            // Clear and populate variant filter
            populateDropdown(elements.variantFilter, filterOptions.variant, 'All Variants');
            
            // Clear and populate station filter
            populateDropdown(elements.stationFilter, filterOptions.station, 'All Stations');
            
            // Clear and populate reason filter
            populateDropdown(elements.reasonFilter, filterOptions.reason, 'All Reasons');
        };
        
        // Helper to populate a dropdown
        const populateDropdown = function(selectElement, options, allLabel = 'All') {
            if (!selectElement) return;
            
            // Clear existing options
            selectElement.innerHTML = '';
            
            // Add "All" option
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = allLabel;
            selectElement.appendChild(allOption);
            
            // Add options from the filtered data
            options.forEach(optionValue => {
                if (!optionValue) return; // Skip empty values
                
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                selectElement.appendChild(option);
            });
        };
        
        // Set date range inputs
        const setDateRange = function(fromDate, toDate) {
            if (fromDate) {
                elements.dateFrom.value = fromDate.toISOString().split('T')[0];
            }
            
            if (toDate) {
                elements.dateTo.value = toDate.toISOString().split('T')[0];
            }
        };
        
        // Update metrics display
        const updateMetrics = function(metrics) {
            if (!metrics) return;
            
            elements.totalCost.textContent = Utils.formatCurrency(metrics.totalCost);
            elements.totalQty.textContent = metrics.totalQty.toLocaleString();
            
            elements.scrapPercent.textContent = `${metrics.scrapPercent}%`;
            elements.rtsPercent.textContent = `${metrics.rtsPercent}%`;
            elements.localPercent.textContent = `${metrics.localPercent}%`;
            
            // Show/hide metrics based on data
            elements.scrapMetric.style.display = metrics.scrapCount > 0 ? '' : 'none';
            elements.rtsMetric.style.display = metrics.rtsCount > 0 ? '' : 'none';
            elements.localMetric.style.display = metrics.localCount > 0 ? '' : 'none';
        };
        
        // Update top rejects table
        const updateTopRejectsTable = function(topRejects) {
            // Show loading while updating
            Utils.showLoading('top-rejects-loading');
            
            // Clear table body
            elements.topRejectsBody.innerHTML = '';
            
            // Check if there's data to display
            if (!topRejects || topRejects.length === 0) {
                Utils.hideLoading('top-rejects-loading');
                Utils.showEmpty('top-rejects-empty');
                return;
            }
            
            // Hide empty state
            Utils.hideEmpty('top-rejects-empty');
            
            // Create rows for each reject
            topRejects.forEach(reject => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td title="${reject.station}">${reject.station}</td>
                    <td title="${reject.parts}">${reject.parts}</td>
                    <td title="${reject.rejectReason}">${reject.rejectReason}</td>
                    <td>${reject.qty}</td>
                    <td>${Utils.formatCurrency(reject.cost)}</td>
                `;
                
                elements.topRejectsBody.appendChild(row);
            });
            
            // Hide loading
            Utils.hideLoading('top-rejects-loading');
        };
        
        // Update trend chart
        const updateTrendChart = function(trendData, sortBy) {
            // Show loading while updating
            Utils.showLoading('trend-chart-loading');
            
            // Check if there's data to display
            if (!trendData || trendData.length === 0) {
                Utils.hideLoading('trend-chart-loading');
                Utils.showEmpty('trend-chart-empty');
                return;
            }
            
            // Hide empty state
            Utils.hideEmpty('trend-chart-empty');
            
            // Create the chart
            ChartModule.createTrendChart('trend-chart-container', trendData, sortBy);
            
            // Hide loading
            Utils.hideLoading('trend-chart-loading');
        };
        
        // Update reasons chart
        const updateReasonsChart = function(reasonsData, sortBy) {
            // Show loading while updating
            Utils.showLoading('reasons-chart-loading');
            
            // Check if there's data to display
            if (!reasonsData || reasonsData.length === 0) {
                Utils.hideLoading('reasons-chart-loading');
                Utils.showEmpty('reasons-chart-empty');
                return;
            }
            
            // Hide empty state
            Utils.hideEmpty('reasons-chart-empty');
            
            // Create the chart
            ChartModule.createReasonsChart('reasons-chart-container', reasonsData, sortBy);
            
            // Hide loading
            Utils.hideLoading('reasons-chart-loading');
        };
        
        // Update special stations section
        const updateSpecialStations = function(stationsData) {
            // Clear container
            elements.specialStationCards.innerHTML = '';
            
            // Check if there's data to display
            if (!stationsData || stationsData.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-state';
                emptyMsg.innerHTML = `
                    <div class="empty-icon">
                        <i class="fas fa-microscope"></i>
                    </div>
                    <div class="empty-text">No data available for special stations.</div>
                `;
                elements.specialStationCards.appendChild(emptyMsg);
                return;
            }
            
            // Create card for each special station
            stationsData.forEach(station => {
                const card = document.createElement('div');
                card.className = 'station-card';
                
                const cardTitle = document.createElement('div');
                cardTitle.className = 'station-card-title';
                cardTitle.innerHTML = `
                    <span>${station.name}</span>
                    <i class="fas fa-info-circle" title="Click for more details"></i>
                `;
                
                const cardMetrics = document.createElement('div');
                cardMetrics.className = 'station-card-metrics';
                cardMetrics.innerHTML = `
                    <div class="station-card-metric">
                        <div class="station-card-value">${station.qty}</div>
                        <div class="station-card-label">Quantity</div>
                    </div>
                    <div class="station-card-metric">
                        <div class="station-card-value">${Utils.formatCurrency(station.cost)}</div>
                        <div class="station-card-label">Cost</div>
                    </div>
                `;
                
                const cardReasons = document.createElement('div');
                cardReasons.className = 'station-card-reasons';
                
                const reasonsTitle = document.createElement('div');
                reasonsTitle.className = 'station-card-reasons-title';
                reasonsTitle.textContent = 'Top Reject Reasons';
                
                const reasonsList = document.createElement('div');
                reasonsList.className = 'station-card-reasons-list';
                
                // Add top reasons
                if (station.topReasons && station.topReasons.length > 0) {
                    station.topReasons.forEach(reason => {
                        const reasonItem = document.createElement('div');
                        reasonItem.className = 'reason-item';
                        reasonItem.innerHTML = `
                            <span class="reason-name">${reason.name}</span>
                            <span class="reason-value">${reason.qty} (${Utils.formatCurrency(reason.cost)})</span>
                        `;
                        reasonsList.appendChild(reasonItem);
                    });
                } else {
                    reasonsList.innerHTML = '<div class="empty-text">No reject reasons available</div>';
                }
                
                // Assemble card
                cardReasons.appendChild(reasonsTitle);
                cardReasons.appendChild(reasonsList);
                
                card.appendChild(cardTitle);
                card.appendChild(cardMetrics);
                card.appendChild(cardReasons);
                
                elements.specialStationCards.appendChild(card);
            });
        };
        
        // Trigger a custom event
        const triggerEvent = function(eventName, detail = {}) {
            const event = new CustomEvent(eventName, { detail });
            document.dispatchEvent(event);
        };
        
        // Return public methods
        return {
            init,
            populateFilterDropdowns,
            setDateRange,
            updateMetrics,
            updateTopRejectsTable,
            updateTrendChart,
            updateReasonsChart,
            updateSpecialStations,
            getCurrentSortBy: () => currentSortBy
        };
    })();

    /**
     * Dashboard Module
     * Orchestrates the overall application
     */
    const DashboardModule = (function() {
        // Initialize the dashboard
        const init = async function() {
            try {
                // Initialize UI module
                UIModule.init();
                
                // Initialize data module
                const dataInitialized = await DataModule.init();
                if (!dataInitialized) {
                    throw new Error('Failed to initialize data module');
                }
                
                // Set up event listeners
                setupEventListeners();
                
                // Set default date range
                const defaultDateRange = Utils.getLastNDaysRange(30);
                UIModule.setDateRange(defaultDateRange.start, defaultDateRange.end);
                
                // Load initial data
                await loadDataForDateRange();
                
                console.log('Dashboard initialized successfully');
                return true;
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                return false;
            }
        };
        
        // Set up event listeners for custom events
        const setupEventListeners = function() {
            // Date range changed
            document.addEventListener('dateRangeChanged', async (event) => {
                const { fromDate, toDate } = event.detail;
                
                if (fromDate && toDate) {
                    DataModule.setDateRange(fromDate, toDate);
                    await loadDataForDateRange();
                }
            });
            
            // Filter changed
            document.addEventListener('filterChanged', async (event) => {
                const { name, value } = event.detail;
                
                if (name) {
                    DataModule.setFilter(name, value);
                    updateDashboard();
                }
            });
            
            // Reset filters
            document.addEventListener('resetFilters', async () => {
                DataModule.resetFilters();
                updateDashboard();
            });
            
            // Sort changed
            document.addEventListener('sortChanged', async (event) => {
                const { sortBy } = event.detail;
                
                if (sortBy) {
                    updateDashboard(sortBy);
                }
            });
            
            // Special stations toggled
            document.addEventListener('specialStationsToggled', async (event) => {
                const { visible } = event.detail;
                
                if (visible) {
                    const specialStationsData = DataModule.getSpecialStationsData();
                    UIModule.updateSpecialStations(specialStationsData);
                }
            });
            
            // Table header sorted
            document.addEventListener('tableHeaderSorted', async (event) => {
                const { field } = event.detail;
                
                if (field) {
                    // Handle table sorting logic
                    console.log('Sort table by:', field);
                    // This would typically involve sorting the data and re-rendering
                    // the table, but we're keeping the simple version for now
                }
            });
        };
        
        // Load data for the current date range
        const loadDataForDateRange = async function() {
            try {
                // Update UI to show loading state
                Utils.showLoading('top-rejects-loading');
                Utils.showLoading('trend-chart-loading');
                Utils.showLoading('reasons-chart-loading');
                
                // Load data
                const dataLoaded = await DataModule.loadDataForDateRange();
                
                if (!dataLoaded) {
                    throw new Error('Failed to load data for selected date range');
                }
                
                // Populate filter dropdowns
                const filterOptions = DataModule.getFilterOptions();
                UIModule.populateFilterDropdowns(filterOptions);
                
                // Update the rest of the dashboard
                updateDashboard(UIModule.getCurrentSortBy());
                
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                
                // Hide loading indicators
                Utils.hideLoading('top-rejects-loading');
                Utils.hideLoading('trend-chart-loading');
                Utils.hideLoading('reasons-chart-loading');
                
                // Show empty states
                Utils.showEmpty('top-rejects-empty');
                Utils.showEmpty('trend-chart-empty');
                Utils.showEmpty('reasons-chart-empty');
                
                return false;
            }
        };
        
        // Update all dashboard components
        const updateDashboard = function(sortBy = UIModule.getCurrentSortBy()) {
            // Get metrics summary
            const metrics = DataModule.getMetricsSummary();
            UIModule.updateMetrics(metrics);
            
            // Get top rejects
            const topRejects = DataModule.getTopRejects(10, sortBy);
            UIModule.updateTopRejectsTable(topRejects);
            
            // Get trend chart data
            const trendData = DataModule.getTrendChartData(sortBy);
            UIModule.updateTrendChart(trendData, sortBy);
            
            // Get top reasons
            const topReasons = DataModule.getTopReasons(5, sortBy);
            UIModule.updateReasonsChart(topReasons, sortBy);
            
            // Update special stations section if visible
            if (document.getElementById('special-stations-section').classList.contains('visible')) {
                const specialStationsData = DataModule.getSpecialStationsData();
                UIModule.updateSpecialStations(specialStationsData);
            }
        };
        
        // Return public methods
        return {
            init
        };
    })();

    // Initialize dashboard when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        DashboardModule.init();
    });
    </script>
</body>
</html>
